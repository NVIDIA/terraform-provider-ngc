# SPDX-FileCopyrightText: Copyright (c) 2024 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
# SPDX-License-Identifier: LicenseRef-NvidiaProprietary

# NVIDIA CORPORATION, its affiliates and licensors retain all intellectual
# property and proprietary rights in and to this material, related
# documentation and any modifications thereto. Any use, reproduction,
# disclosure or distribution of this material and related documentation
# without an express license agreement from NVIDIA CORPORATION or
# its affiliates is strictly prohibited.

name: Release

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags (v1.0.0, v2.1.3, etc.)
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Run in dry-run mode (no actual release)'
        required: false
        default: 'false'
        type: boolean

env:
  GO_VERSION: '1.24'
  GORELEASER_VERSION: 'v2.2.0'

permissions:
  contents: write       # Required for creating releases
  packages: write       # Required if publishing to GHCR
  id-token: write       # Required for signing (if using cosign)

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Required for goreleaser changelog generation

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Install dependencies
        run: |
          # Install Python and nvsec if needed for signing/publishing
          # Uncomment if you need nvsec for NVIDIA artifact signing
          # sudo apt-get update
          # sudo apt-get install -y python3 python3-pip
          # python3 -m pip install nvsec -i https://urm.nvidia.com/artifactory/api/pypi/sw-cloudsec-pypi/simple \
          #   --extra-index-url https://urm.nvidia.com/artifactory/api/pypi/sw-cftt-pypi-local/simple

      - name: Verify tag
        if: github.event_name == 'push'
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          echo "üè∑Ô∏è Releasing version: $TAG"
          echo "RELEASE_TAG=$TAG" >> $GITHUB_ENV

      - name: Run GoReleaser (Dry Run)
        if: github.event.inputs.dry_run == 'true'
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: ${{ env.GORELEASER_VERSION }}
          args: release --clean --snapshot --skip=publish
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run GoReleaser
        if: github.event.inputs.dry_run != 'true'
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: ${{ env.GORELEASER_VERSION }}
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Add artifact registry credentials if publishing to URM
          # ARTIFACTORY_URM_USERNAME: ${{ secrets.ARTIFACTORY_URM_USERNAME }}
          # ARTIFACTORY_URM_SECRET: ${{ secrets.ARTIFACTORY_URM_SECRET }}

      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts
          path: |
            dist/*.zip
            dist/*_SHA256SUMS*
          retention-days: 30

      - name: Release summary
        run: |
          echo "## üéâ Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
            echo "üß™ **Dry Run Mode** - No release was created" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚úÖ Release created successfully!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "üì¶ **Version:** \`${{ env.RELEASE_TAG || 'snapshot' }}\`" >> $GITHUB_STEP_SUMMARY
            echo "üîó **Release URL:** ${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ env.RELEASE_TAG }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          ls -la dist/*.zip 2>/dev/null | awk '{print "- `" $NF "`"}' >> $GITHUB_STEP_SUMMARY || echo "No artifacts found" >> $GITHUB_STEP_SUMMARY

  # Optional: Security scan on release artifacts
  security-scan:
    name: Security Scan Release
    runs-on: ubuntu-latest
    needs: [release]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download release artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-artifacts
          path: dist/

      - name: Run Trivy vulnerability scan
        uses: nvidia/dsx-github-actions/.github/actions/trivy-scan@main
        with:
          scan-type: 'fs'
          scan-ref: '.'
          severity: 'HIGH,CRITICAL'
          skip-dirs: 'vendor,node_modules'
          ignore-unfixed: 'true'
          upload-sarif: 'true'
          fail-on-findings: 'false'
          github-token: ${{ secrets.GITHUB_TOKEN }}

  # Optional: Notify on release
  notify:
    name: Notify Release
    runs-on: ubuntu-latest
    needs: [release, security-scan]
    if: always() && github.event.inputs.dry_run != 'true'
    steps:
      - name: Notify success
        if: needs.release.result == 'success'
        run: |
          echo "‚úÖ Release ${{ env.RELEASE_TAG || github.ref_name }} completed successfully!"
          # Add Slack notification here if needed
          # Example using slack-notify action:
          # uses: nvidia/dsx-github-actions/.github/actions/slack-notify@main
          # with:
          #   slack-bot-token: ${{ secrets.SLACK_BOT_TOKEN }}
          #   channel-id: 'your-channel-id'
          #   message: "üéâ New release published: terraform-provider-ngc ${{ env.RELEASE_TAG }}"

      - name: Notify failure
        if: needs.release.result == 'failure'
        run: |
          echo "‚ùå Release failed!"
          exit 1
